---
title: "Toggl APIã§æ—¥å ±ç”¨ã®æ´»å‹•è¨˜éŒ²ã‚’åé›†ã™ã‚‹"
emoji: "ğŸ“¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["toggl", "deno"]
published: false
---

ä»•äº‹ã‚’ã—ã¦ã„ã‚‹ã¨ã€æ—¥å ±ã¨ã„ã†å½¢ã§ä¸€æ—¥ã®æ¥­å‹™ã‚’å ±å‘Šã™ã‚‹ã“ã¨ã‚‚ã‚ã‚‹ã¨æ€ã†ã€‚
Togglã‚’ä½¿ãˆã°ã€æ¥­å‹™ã®è¨˜éŒ²ã‚’å¯è¦–åŒ–ã§ãã‚‹ã—ã€APIã‚’ä½¿ãˆã°æ—¥å ±ã«å½¹ç«‹ã¤å½¢å¼ã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã‚‹ã€‚

ã®ã§ã€æ›¸ã„ãŸã€‚

## ç’°å¢ƒ

ä»Šå›ã¯ä»¥ä¸‹ã®ç’°å¢ƒã§å®Ÿè¡Œã™ã‚‹ã‚‚ã®ã‚’ä½œæˆã—ãŸã€‚

- Deno 1.40.5
- WSL2 Ubuntu 22.04

## Toggl ã®ä½¿ã„æ–¹

- ä»•äº‹ã«é–¢ã™ã‚‹ã“ã¨ã‚’ã¾ã¨ã‚ã‚‹ãŸã‚ã€`Client` ã«ä¼šç¤¾åã‚’è¨­å®šã™ã‚‹
- ä»•äº‹ã«é–¢ã™ã‚‹ `Project` ã¯ã€ä¼šç¤¾ã® `Client` ã«å±ã™ã‚‹ã‚ˆã†ã«è¨­å®šã™ã‚‹
- é›‘å¤šãªã‚¿ã‚¹ã‚¯ã¯ `misc.` ã¨ã„ã†ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã¾ã¨ã‚ã¦ã„ã‚‹

## Toggl APIã‚’ Deno ã§å©ã

### API token ã®å–å¾—

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«å¾“ã„ã€API token ã‚’å–å¾—ã™ã‚‹ã€‚

[Authentication | Track Your Way](https://developers.track.toggl.com/docs/authentication)

### è¨˜éŒ²ã—ãŸTime Entriesã‚’å–å¾—ã™ã‚‹

Toggl ã§è¨˜éŒ²ã•ã‚ŒãŸ Time Entries ã¯ä»¥ä¸‹ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§å–å¾—ã§ãã‚‹ã€‚

[Time entries | Track Your Way](https://developers.track.toggl.com/docs/api/time_entries)

- ã‚¯ã‚¨ãƒªã« `start_date` ã¨ `end_date` ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€ãã®ç¯„å›²ã® Time Entries ã‚’å–å¾—ã§ãã‚‹
- `meta` ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€`Client` ã‚„ `Project` ãªã©ã®å€¤ã‚‚å–å¾—ã§ãã‚‹
  - ä½™è¨ˆã«APIã‚’å©ãå¿…è¦ãŒãªããªã‚‹

### å®Ÿè£…

ä¸‹è¨˜ã¯å®Ÿéš›ã®å®Ÿè£…ä¾‹ã§ã€ è¦ç‚¹ã¯ä»¥ä¸‹ã®é€šã‚Šã€‚

- API tokenã¯ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã«ã—ãŸ
- ä¸€æ—¥ã®ç¯„å›²ãŒ 6:00 ã‹ã‚‰ ç¿Œ 6:00 ã¾ã§ã¨ãªã‚‹ã‚ˆã†ã«å–å¾—ã™ã‚‹

```ts
// report.ts

const d = new Date();
d.setTime(d.getTime() - 6 * 60 * 60 * 1000);
const today = d.toISOString().split("T")[0];
const tomorrow = new Date(d.getTime() + 24 * 60 * 60 * 1000).toISOString().split("T")[0];
const start_date = encodeURIComponent(today + "T06:00:00+09:00");
const end_date = encodeURIComponent(tomorrow + "T06:00:00+09:00");
const endpoint = `https://api.track.toggl.com/api/v9/me/time_entries?start_date=${start_date}&end_date=${end_date}&meta=true`;

const api_token = (await Deno.readTextFile("api_token.txt")).trim();

const res = await fetch(endpoint, {
    method: "GET",
    headers: {
        "Content-Type": "application/json",
        "Authorization": `Basic ${btoa(`${api_token}:api_token`)}`,
    },
});

const data = await res.json();

type Entry = {
    "client_name": string;
    "project_name": string;
    "description": string;
    "duration": number;
};
const client = "ä¼šç¤¾å";
const work_entries = data.filter((entry: Entry) => entry.client_name === client);

// Projectã”ã¨ã€ã‚¿ã‚¹ã‚¯ã”ã¨ã«é›†è¨ˆã™ã‚‹
type Summary = Record<string, Record<string, number>>;

const summary: Summary = {};
for (const entry of work_entries) {
    const project = entry.project_name;
    const task = entry.description;
    const duration = entry.duration;

    if (!summary[project]) {
        summary[project] = {};
    }
    if (!summary[project][task]) {
        summary[project][task] = 0;
    }
    if (duration > 0) {
        summary[project][task] += duration;
    }
}

// é›†è¨ˆçµæœã‚’ markdown æ›¸å¼ã§æ‰±ã„ã‚„ã™ã„å½¢ã«ã™ã‚‹
// Project ã€Œmisc.ã€ ã ã‘ã¯ã‚ã¨ã§è¡¨ç¤ºã™ã‚‹
for (const project in summary) {
    if (project === "misc.") {
        continue;
    }
    console.log(`### ${project}`);
    for (const task in summary[project]) {
        const duration = summary[project][task] / 3600;
        console.log(`- ${task}: ${duration.toFixed(2)}h`);
    }
    console.log("");
}
if (summary["misc."]) {
    console.log("### misc.");
    for (const task in summary["misc."]) {
        const duration = summary["misc."][task] / 3600;
        console.log(`- ${task}: ${duration.toFixed(2)}h`);
    }
}
```

## ä½¿ã„æ–¹

```sh
deno run --allow-net --allow-read report.ts
```

### WSLã®å¤–(ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰)ã«å¼•ãæ¸¡ã™

```sh
deno run --allow-net --allow-read report.ts | iconv -t utf-16 | clip.exe
```
